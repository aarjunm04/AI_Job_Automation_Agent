# =============================================================================
# AI Job Automation Agent - Production Docker Compose Setup
# =============================================================================
# Version: 3.8
# Purpose: Orchestrate MCP Server, RAG Server, PostgreSQL, and Redis
#
# CRITICAL NOTES:
# - n8n runs SEPARATELY as standalone infrastructure (not included)
# - All services use env_file pointing to ~/narad.env (secrets management)
# - Services communicate via internal docker network (service names as hostnames)
# - Chrome extension & n8n reach services via localhost on host
# - Data persistence: ./postgres_data/, ./dump.rdb, ./.chroma/, ./logs/
# =============================================================================

version: '3.8'

networks:
  ai_job_network:
    driver: bridge
    name: ai_job_network

volumes:
  # Named volume for ChromaDB vector store
  chromadb_data:
    driver: local

services:
  # =============================================================================
  # PostgreSQL 15 - Primary database for MCP Server and system state
  # =============================================================================
  postgres:
    image: postgres:15-alpine
    container_name: ai_postgres
    restart: unless-stopped
    
    env_file:
      - ~/narad.env
    
    environment:
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
      PGDATA: /var/lib/postgresql/data/pgdata
    
    # Direct bind mount to existing postgres_data directory
    volumes:
      - ./postgres_data:/var/lib/postgresql/data
    
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER:-ai_user} -d $${POSTGRES_DB:-ai_job_db} || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 15s
    
    networks:
      - ai_job_network

  # =============================================================================
  # Redis 7 - In-memory cache and session store for MCP/RAG servers
  # =============================================================================
  redis:
    image: redis:7-alpine
    container_name: ai_redis
    restart: unless-stopped
    
    # Redis persistence configuration
    command: redis-server --appendonly no --save 900 1 --save 300 10 --save 60 10000 --dir /data
    
    # Mount project root as /data so Redis writes dump.rdb to host
    volumes:
      - ./redis_data:/data
    
    healthcheck:
      test: ["CMD-SHELL", "redis-cli ping | grep PONG || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6
      start_period: 10s
    
    networks:
      - ai_job_network

  # =============================================================================
  # MCP Server - FastAPI service for model context protocol operations
  # =============================================================================
  mcp-server:
    build:
      context: .
      dockerfile: mcp/Dockerfile
    
    container_name: ai_mcp_server
    restart: unless-stopped
    
    env_file:
      - ~/narad.env
    
    environment:
      # Service-specific overrides
      DEBUG: "false"
      LOG_LEVEL: "info"
      # Ensure MCP uses containerized database
      DATABASE_URL: "postgresql://$${POSTGRES_USER:-ai_user}:$${POSTGRES_PASSWORD}@postgres:5432/$${POSTGRES_DB:-ai_job_db}"
      REDIS_URL: "redis://redis:6379/0"
    
    ports:
      - "3001:3001"
    
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 20s
    
    # Mount logs for debugging
    volumes:
      - ./logs:/app/logs
    
    networks:
      - ai_job_network
    
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G

  # =============================================================================
  # RAG Server - FastAPI service for retrieval-augmented generation
  # =============================================================================
  rag-server:
    build:
      context: .
      dockerfile: rag_systems/Dockerfile
    
    container_name: ai_rag_server
    restart: unless-stopped
    
    env_file:
      - ~/narad.env
    
    environment:
      DEBUG: "false"
      LOG_LEVEL: "info"
      # ChromaDB is in project root .chroma directory
      CHROMA_DIR: "/app/.chroma"
      REDIS_URL: "redis://redis:6379/0"
    
    ports:
      - "8090:8090"
    
    depends_on:
      redis:
        condition: service_healthy
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/health"]
      interval: 15s
      timeout: 5s
      retries: 5
      start_period: 20s
    
    # Mount ChromaDB directory from project root and logs
    volumes:
      - ./.chroma:/app/.chroma
      - ./logs:/app/logs
    
    networks:
      - ai_job_network
    
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '1'
          memory: 1G







