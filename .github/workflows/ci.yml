name: CI â€” Lint, Type Check, Tests

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: "3.11"
  ACTIVE_DB: local
  LOCAL_POSTGRES_URL: postgresql://user:pass@localhost/test
  LOG_LEVEL: INFO
  CHROMADB_PATH: /tmp/chromadb
  RESUME_DIR: /tmp/resumes
  DEFAULT_RESUME: test.pdf
  XAI_API_KEY: ${{ secrets.XAI_API_KEY || 'test' }}
  GROQ_API_KEY: ${{ secrets.GROQ_API_KEY || 'test' }}
  AGENTOPS_API_KEY: ${{ secrets.AGENTOPS_API_KEY || 'test' }}
  PERPLEXITY_API_KEY: ${{ secrets.PERPLEXITY_API_KEY || 'test' }}
  CEREBRAS_API_KEY: ${{ secrets.CEREBRAS_API_KEY || '' }}
  SAMBANOVA_API_KEY: ${{ secrets.SAMBANOVA_API_KEY || '' }}
  NVIDIA_NIM_API_KEY: ${{ secrets.NVIDIA_NIM_API_KEY || '' }}
  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY || '' }}
  SUPABASE_URL: ${{ secrets.SUPABASE_URL || '' }}
  SUPABASE_KEY: ${{ secrets.SUPABASE_KEY || '' }}
  JOOBLE_API_KEY: ${{ secrets.JOOBLE_API_KEY || '' }}

jobs:
  lint:
    name: Lint + Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ env.PYTHON_VERSION }}-

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Black formatting check
        continue-on-error: true
        run: black --check --diff . --line-length 100

      - name: isort import order check
        continue-on-error: true
        run: isort --check-only --diff .

      - name: Mypy type check
        run: mypy . --ignore-missing-imports --no-strict-optional --exclude 'tests/' --exclude 'migrations/'

  test:
    name: Run Test Suite
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [lint]
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ env.PYTHON_VERSION }}-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-${{ env.PYTHON_VERSION }}-

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run test suite
        run: |
          if [ -d "tests" ]; then
            set +e
            pytest tests/ -p no:warnings --tb=short -q
            test_status=$?
            set -e
            if [ "$test_status" -eq 5 ]; then
              echo "No tests collected yet"
              exit 0
            fi
            exit "$test_status"
          else
            echo "No tests dir yet"
          fi
